---
layout: page
title: Practical 7
permalink: /practical7/
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      fig.path = "",
                      comment="", 
                      prompt=TRUE)
Sys.setlocale("LC_TIME", "C")
```

# Objectives

The learning objectives for this practical are:

  * Writing R scripts.
  * How to manipulate dates in data.
  * How to create and use factor objects.

# Setup and background

To do this practical you need an installation of R and RStudio. You can find
the instructions in the [setup](/setup#r-and-rstudio) link on how to install R
and RStudio in your system. For a smooth development of this practical, it is
strongly recommended that you follow and finish the previous
[seminar 4](/seminar4/) on how to get started with R and RStudio.

We will download some COVID19 data to illustrate the use of R and RStudio.
Please follow the next two steps:

1. Go to the Catalan Health Departament COVID19 data portal at
   [https://dadescovid.cat](https://dadescovid.cat) and switch the language to
   "ENGLISH" using the pull-down menu on the top-right corner of the page.
2. Follow the downloads link and on the next page click and download the file
   corresponding to the "7 DAY AGGREGATION" for "CATALUNYA".
   Make sure you know exactly where in your filesystem this file
   has been downloaded. **Tip:** some browsers automatically download files
   into a folder called "Downloads" or under a name corresponding to the
   translation of "Downloads" to the default language of your operating system.
3. Make a directory in your filesystem, for instance at your _home_ directory,
   called `practical7` and copy in it the downloaded file.
4. Since the downloaded file is a ZIP file, uncompress as you did in
   [practical 1](/practical1/) so that you finally have a file called
   `catalunya_setmanal.csv` in the directory `practical7`.

If you are using the UPF [myapps](https://myapps.upf.edu) cloud to run RStudio,
then you need to either use an internet browser in _myapps_ to download the data
file directly in the _myapps_ cloud or upload to the _myapps_ cloud the file
that you have downloaded in your own computer.

# Writing R scripts

We may often use an interactive R session to quickly examine data or make some
straightforward calculations. In such an interactive session, we can also recover
previous instructions in the R shell by pressing the `upwards arrow` key. However,
if we really want to keep track of the R commands we are using, we should write
them in a text file with filename extension `.R`, which we shall refer hereafter
as an _R script_. 

There are two main ways to create an R script: (1) opening a new file with a
text editor and saving it with filename that includes the `.R` extension, or (2)
if we are working with RStudio, then we click on the `File` menu and select
the options `New File` -> `R Script`. When we do that we should be getting the
RStudio window splitted in four panes, the default three ones and one additional
one for the newly created R script, as shown in the captured window below.

![](RStudioNewScript.png)

Type in the newly created R script (either with a text editor or with RStudio)
the following two lines to read the CSV file downloaded in the previous section.
The first line is a comment. Lines starting with the `#` symbol are comments in R.

```{r}
## read COVID19 data
dat <- read.csv("catalunya_setmanal.csv", sep=";", stringsAsFactors=TRUE)
```

Now save the R script in the directory `practical7` under the filename
`covid19analysis.R`.

To execute a specific line of an R script in RStudio you should move the cursor
to that line in the pane with the script file and press the key combination
`Ctrl+Enter`. Alternatively, you can also copy and paste the line from the script
to the R shell, specially if you are not working with RStudio.

The previous line may produce an error if the current working directory of
R is not pointing to the directory where the file `catalunya_setmanal.csv` is;
see previous [seminar 4](/seminar4/) if you need to find out how to change
the working directory in R and RStudio. In general, changing the working directory
should be always performed in the R shell and **NEVER** include the instruction that
changes the working directory in an R script. The reason is because you or somebody
else may want to run that script in a different computer where the directory with
the data may be called differently.

You can examine the first 6 rows of the loaded CSV file with the `head()` function
as follows:

```{r}
head(dat)
```

**Exercise**: now add to the script `covid19analysis.R` the following two lines
to obtain a new `data.frame` object called `datg` that includes only data from
the general population, i.e., excluding data from geriatric residences. You have
to figure out the code that replaces de questions marks `??????`.

```{r eval=FALSE}
mask <- ??????
datg <- dat[mask, ]
```

Once you subset data, it is always convenient to compare the dimensions of the
original and resulting object, using the function `dim()`, and think whether the
difference in dimensions makes sense (e.g., subsetting should always lead to a
smaller object in some dimension).

```{r include=FALSE}
mask <- dat$RESIDENCIA == "No"
datg <- dat[mask, ]
```

# Date-data management

These are the first 6 rows of the filtered `data.frame` object you should have
obtained from the previous exercise:

```{r}
head(datg)
```

It has two columns with date information (`DATA_INI` and `DATA_FI`),
corresponding to the begining and end of the 7-day period of the data of that
row, but which are stored as string character vectors (more specifically as
[factors](https://funcompbio.github.io/lecture6/#25)). However, R provides a
way to store dates as such and this has the advantage that facilitates
manipulating them for analysis purposes.

For instance, to transform the two columns containing date data we should
use the function `as.Date()` as follows:

```{r}
startdate <- as.Date(datg$DATA_INI)
enddate <- as.Date(datg$DATA_FI)
```

While R displays these objects as vectors of character strings, they do belong
to a different class of objects, the class _Date_.

```{r}
head(startdate)
class(startdate)
head(enddate)
class(enddate)
```


Having dates stored as _Date_-class objects facilitates operations on dates such
as calculating time differences:

```{r}
head(enddate - startdate + 1)
```

or subsetting data for a period of time. For instance, let's subset the data,
selecting rows corresponding to data between January and November from 2020,
the year in which the COVID19 pandemic started:

```{r}
mask <- startdate >= as.Date("2020-01-01") & enddate <= as.Date("2020-11-30")
sum(mask)
datg20 <- datg[mask, ]
dim(datg20)
```

Note that the number of `TRUE` values in the logical mask matches the resulting
number of rows in the subsetted object `datg20`.


Date data also allows one to easily extract the month of each date:

```{r}
startdate <- as.Date(datg20$DATA_INI)
m <- months(startdate, abbreviate=TRUE)
head(m)
class(m)
```

where we have to use the argument `abbreviate=TRUE` in the `months()` function
to obtain a vector of equally sized character strings, which may be useful
for visualization purposes.

**Important:** The previous vector `m` may contain the names of the months
in a different language than English when the regional configuration of your
operating system, known as
[locale configuration](https://en.wikipedia.org/wiki/Locale_%28computer_software%29),
is also different to English. In such a case, it may be handy to switch at
least the regional time configuration to English, to facilitate following
the rest of this practical. To do that, type the following instruction on
the R shell:

```{r, eval=FALSE}
Sys.setlocale("LC_TIME", "C")
```

and then type again:
```{r}
m <- months(startdate, abbreviate=TRUE)
```
Verify that now the vector `m` has the month names in English.

# Factors

[Factors](https://funcompbio.github.io/lecture6/#25) in R are a class of objects
that serve the purpose of storing what is known in statistics as a
[categorical variable](https://en.wikipedia.org/wiki/Categorical_variable),
which is a variable that takes values from a limited number of _categories_,
also known as _levels_. So factors are pretty much like vectors of character
strings, but with additional information about what are the different values
that may occur on those vectors.

Not all vectors of character strings are suitable to become factors. For
instance, a vector of character strings corresponding to gene identifiers
tipically should not become a factor in R, because those identifiers do not
represent any kind of _category_ grouping observations.

Factors are useful, however, in the context of a statistical analysis and
data visualization, involving categorical variables. To create a factor
object we should call the function `factor()` giving a vector of character
strings as argument. Let's consider converting the previous vector `m`
of character strings to a factor.

```{r}
mf <- factor(m)
head(mf)
```
We can see that R displays factors differently to character strings, by
showing the values without double quotes (`"`) and providing additional
information about the possible _levels_ of that factor. We can access the
level information from a factor object with the functions `levels()` and
`nlevels()`.

```{r}
levels(mf)
nlevels(mf)
```
Sometimes, we may want the levels of a factor to comprise a set of specific
values or to be ordered in a specific way. This could be the case of the
previous factor `mf`, where we would like for instance to have the
levels corresponding to the months of the year and chronologically ordered.
We can do that as follows:

```{r}
mf <- factor(m, levels=c("Jan", "Feb", "Mar", "Apr", "May", "Jun",
                         "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"))
head(mf)
levels(mf)
nlevels(mf)
```
**Important:** The previous call to the `factor()` function will **only work**
if your regional time configuration is English. If you are working with a
non-English regional time configuration, you should change the level names
in the argument `levels` to the language that you are using.

Now, we can build a contingency table of the level occurrences of a factor
using the function `table()`.

```{r}
table(mf)
```
We can see, there is no data in 2020 for the months of January (because
data was not yet recorded) and December (because it is outside the period
we have subsetted the data). We can remove levels of a factor for which there
is no data with the function `droplevels()`.

```{r}
mf <- droplevels(mf)
levels(mf)
table(mf)
```

Using this factor we can easily visualize the distribution of the column
`R0_CONFIRMAT_M`
([R0 basic reproduction number](https://en.wikipedia.org/wiki/Basic_reproduction_number))
as function of the month, calling plot with the formula notation `x ~ y`
(add this plotting instruction to the `covid19analysis.R` script):

```{r R0byMonth}
plot(datg20$R0_CONFIRMAT_M ~ mf)
```

where here `datg20` refers to the subset of the original `data.frame`
object `dat`, excluding data from geriatric residences and including only
data between January and November 2020, and `mf` refers to the factor object
with the months from that subset of data. The resulting
plot contains so-called [box plots](https://en.wikipedia.org/wiki/Box_plot)
for each month, which allow to visualize the location of the data in terms
of [quartiles](https://en.wikipedia.org/wiki/Quartile).

We can see that February has no data points for the column `R0_CONFIRMAT_M`
despite there are data rows for that month. To find out why we do not see
any data on the plot we can inspect the values of `R0_CONFIRMAT_M` for
the month of February as follows:

```{r}
mask <- mf == "Feb"
datg20$R0_CONFIRMAT_M[mask]
```
The value `NA` in R means _not available_ and R treats it in a special
way depending on the operation that is performing. In the case of plots, `NA`
values are ignored.

**Exercise:** look up in the help page of the `plot()` function, how can you
change the labels for the `x` and `y` axes to a readable label whose meaning
stands alone and minimally describes the data visualized in that axis. The
resulting plot should be identical to the one above, but with the axes labels
changed.

**Exercise:** produce the same kind of plot, but this time showing in the
_y_-axis the values of the column `IEPG_CONFIRMAT`, corresponding to the
[effective potential growth](https://doi.org/10.1371/journal.pone.0243701)
also known as risk of outbreak. Can you identify the month in which this risk
has increased the most?

```{r eval=FALSE}
## plot risk of outbreak as function of the month
plot(datg20$IEPG_CONFIRMAT ~ mf, xlab="Month", ylab="Risk of outbreak")
```
